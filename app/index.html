<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Model Search - AngularBased</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <script src="http://vw-test.wpdlr.co/wp-content/themes/_fdt/js/custom.modernizr.js"></script>
    <script src="http://vw-test.wpdlr.co/wp-includes/js/jquery/jquery.js?ver=1.10.2"></script>
    <script src="http://vw-test.wpdlr.co/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1"></script>

    <link href="//cdn.wpdlr.co.s3.amazonaws.com/assets/general/css/foundation/default.css" rel="stylesheet" type="text/css">
    <link href="//cdn.wpdlr.co/assets/general/css/foundation/general_enclosed_foundicons.css" rel="stylesheet">
    <!-- build:css({.tmp,app}) styles/main.css -->
    <link rel="stylesheet" href="styles/main.css">
    <!-- endbuild -->
  </head>
  <body ng-app="vehicleModelSearchApp">

    <!-- Add your site or application content here -->
    <div class="row" ng-controller="baseCtrl" ng-view></div>

    <script src="http://cdn.wpdlr.co.s3.amazonaws.com/assets/general/js/angular/angular.min.js"></script>
    <script src="http://cdn.wpdlr.co.s3.amazonaws.com/assets/general/js/lodash/lodash.min.js"></script>
    <!-- build:js scripts/vendor.js -->
    <!-- bower:js -->
    <script src="bower_components/angular-route/angular-route.js"></script>
    <!-- endbower -->
    <!-- endbuild -->

    <script type="text/javascript">
      angular.module('vehicleModelSearchApp', ['ngRoute'])
        .config(['$routeProvider', '$locationProvider',
          function ($routeProvider, $locationProvider) {
            $routeProvider
              .when('/', {
                templateUrl: 'views/main.html'
              })
              .when('/model/:model', {
                controller: 'trimCtrl',
                templateUrl: 'views/trim.html'
              })
              .when('/model/:model/trim/:trim', {
                controller: 'colorCtrl',
                templateUrl: 'views/color.html'
              })
              .when('/model/:model/trim/:trim/color/:ext_color_code', {
                controller: 'quoteCtrl',
                templateUrl: 'views/quote.html'
              })
              .otherwise({
                redirectTo: '/'
              });
            $locationProvider.html5Mode(false);
          }
        ])
        .constant('_', _)
        .controller('trimCtrl', function ($scope, $log, $routeParams) {
          $scope.subase = {
            ele: _.findIndex($scope.baseF.modelTrim, $routeParams),
            current: $routeParams
          };
          // $log.info($routeParams, $scope.baseF.modelTrim, $scope.subase.ele);
        })
        .controller('colorCtrl', function ($scope, $log, $routeParams) {
          $scope.subase = {
            ele: _.findIndex($scope.baseF.modelTrimColor, $routeParams),
            current: $routeParams
          };
          // $log.info($routeParams, _.find($scope.baseF.modelTrimColor, { trim: $routeParams.trim }), $scope.subase.sel);
        })
        .controller('quoteCtrl', function ($scope, $log, $routeParams) {
          $scope.subase = {
            sel: _.find($scope.base.collection, $routeParams),
            // element_hash: '{element_hash}',
            // the_permalink: '{the_permalink}',
            qtypeSelected: 'lease',
            creditRating: 'great',
            leaseTerm: '24',
            milesYear: '10,000',
            financeTerm: '24'
          };
          // $log.info($routeParams, $scope.subase.sel);
        })
        .controller('baseCtrl', function ($scope, $log, $http) {
          var basicParams = {
            f: 'json',
            show: 'all',
            type: 'new',
            d: 'vehicles',
            make: '{setup_dealer_primary_make}',
            e: 'trim,evox_vif,ext_color_code,msrp'
          };
          var groupParams = _.assign({
            q: 'group=year,model,trim,exterior_color',
            k: 'year,model,trim,evox_vif,ext_color_code,exterior_color,msrp'
          }, basicParams);
          var inventoryParams = _.assign({
            k: 'year,model,trim,ext_color_code'
          }, basicParams);
          var cleanData = function (data) {
            return _.map(data, function (ele) {
              return _.assign(ele, {
                modelLabel: ele.model,
                trimLabel: ele.trim,
                model: ele.model.replace(' ', '_'),
                trim: ele.trim.replace(' ', '_').replace('/', '*')
              });
            });
          };
          var createTree = function (data) {
            var tree = {};
            // tree.ttsrc = '{src}';
            tree.yearArray = _.map(_.uniq(data, 'year'), function (ele) {
              ele.yearlabel = ele.year;
              return ele;
            });
            tree.yearSelected = tree.yearArray[0];
            tree.collection = _.sortBy(data, 'ext_color_code').reverse();
            return tree;
          };
          var filterCollection = function () {
            var data = _.where($scope.base.collection, { year: $scope.base.yearSelected.year });
            var tree = {};
            tree.models = (function () {
              var msrpuniq = _.uniq(_.sortBy(data, 'msrp'), 'model');
              var modeluniq = _.map(_.uniq(data, 'model'), function (ele) {
                ele.msrpmodel = _.find(msrpuniq, { model: ele.model }).msrp;
                return ele;
              });
              return _.sortBy(modeluniq, 'model');
            }());
            tree.modelTrim = _.map(tree.models, function (ele) {
              var trims = _.where(data, {
                model: ele.model
              });
              var trimsort = _.sortBy(trims, 'msrp');
              return {
                model: ele.model,
                trimuniq: _.sortBy(
                  _.map(
                    _.uniq(trims, 'trim'), function (ele) {
                      ele.msrptrim = _.find(trimsort, { trim: ele.trim }).msrp;
                      return ele;
                    }
                  ), 'msrp')
              }
            });
            tree.modelTrimColor = _.flatten(_.map(tree.modelTrim, function (ele) {
              var trimarray = _.map(ele.trimuniq, function (oto) {
                var colors = _.where(data, {
                  model: oto.model,
                  trim: oto.trim
                });
                return {
                  model: oto.model,
                  trim: oto.trim,
                  colors: _.sortBy(_.uniq(colors, 'ext_color_code'), 'msrp')
                };
              });
              return trimarray;
            }));
            return tree;
          };
          var splityear = function (data) {
            // split the inventory collection by year
            // $log.info('yearArray',$scope.base.yearArray);
            var split = [];
            for (var i = $scope.base.yearArray.length - 1; i >= 0; i--) {
              split.push({
                year: $scope.base.yearArray[i].year,
                vehicles: _.where(data, { year: $scope.base.yearArray[i].year })
              });
            };
            return split;
          };
          var updateYearSel =  function () {
            // modify yearArray -> yearlabel
            _.forEach($scope.base.yearArray, function (ele) {
              var yearele = _.find($scope.vehicles, { year: ele.yearlabel });
              ele.yearlabel = ele.yearlabel + ' - (' + yearele.vehicles.length + ' vehicles)';
            });
          };
          var countCollection = function () {
            // process the inventory and assign the new attribute to the base.collection
            if (_.isEmpty($scope.baseF.models[0].modelCount)) {
              var vehicleset = _.find($scope.vehicles, { year: $scope.base.yearSelected.year }).vehicles;
              _.forEach($scope.baseF.models, function (ele) {
                ele.modelCount = _.where(vehicleset, { model: ele.modelLabel }).length;
              });
              _.forEach($scope.baseF.modelTrim, function (ele) {
                _.forEach(ele.trimuniq, function (sub) {
                  sub.trimCount = _.where(vehicleset, { model: ele.model.replace('_',' '), trim: sub.trimLabel }).length;
                });
              });
              _.forEach($scope.baseF.modelTrimColor, function (ele) {
                _.forEach(ele.colors, function (sub) {
                  sub.colorCount = _.where(vehicleset, { model: ele.model.replace('_',' '), trim: ele.trim.replace('_',' '), ext_color_code: sub.ext_color_code }).length;
                });
              });
            }
          };
          $scope.base = {};
          $scope.vehicles = [];
          $scope.$watch('base.yearSelected', function (newv, oldv) {
            if (newv) {
              $scope.baseF = filterCollection();
              if (!_.isEmpty($scope.vehicles)) {
                countCollection();
              }
            }
          });
          $scope.$watch('vehicles', function (newv, oldv) {
            if (!_.isEmpty(newv)) {
              updateYearSel();
              countCollection();
            }
          });
          $http({
            // method: 'POST',
            method: 'GET',
            // url: '{home}/api/',
            url: 'model.json',
            params: groupParams
          })
          .success(function (data) {
            $scope.base = createTree(cleanData(data));
            // get complete inventory and count by year/model, year/trim, year/color
            $http({
              // method: 'POST',
              method: 'GET',
              // url: '{home}/api/',
              url: 'inventory.json',
              params: inventoryParams
            })
            .success(function (data) {
              $scope.vehicles = splityear(data);
              // $log.info(data.length);
            });
          });
        });
    </script>

    <!-- build:js({.tmp,app}) scripts/scripts.js -->
    <!-- endbuild -->

    <script src="//cdn.wpdlr.co/assets/general/js/foundation/foundation.min.js" defer="" async=""></script>
    <script style="text/javascript">
      window.onload = function() { jQuery(document).foundation(); };
    </script>
  </body>
</html>
