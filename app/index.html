<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Model Search - AngularBased</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <script src="http://vw-test.wpdlr.co/wp-content/themes/_fdt/js/custom.modernizr.js"></script>
    <script src="http://vw-test.wpdlr.co/wp-includes/js/jquery/jquery.js?ver=1.10.2"></script>
    <script src="http://vw-test.wpdlr.co/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1"></script>

    <link href="//cdn.wpdlr.co.s3.amazonaws.com/assets/general/css/foundation/default.css" rel="stylesheet" type="text/css">
    <link href="//cdn.wpdlr.co/assets/general/css/foundation/general_enclosed_foundicons.css" rel="stylesheet">
    <!-- build:css({.tmp,app}) styles/main.css -->
    <link rel="stylesheet" href="styles/main.css">
    <!-- endbuild -->
  </head>
  <body ng-app="vehicleModelSearchApp">

    <!-- Add your site or application content here -->
    <div class="row" ng-controller="baseCtrl" ng-view></div>

    <script src="http://cdn.wpdlr.co.s3.amazonaws.com/assets/general/js/angular/angular.min.js"></script>
    <script src="http://cdn.wpdlr.co.s3.amazonaws.com/assets/general/js/lodash/lodash.min.js"></script>
    <!-- build:js scripts/vendor.js -->
    <!-- bower:js -->
    <script src="bower_components/angular-route/angular-route.js"></script>
    <!-- endbower -->
    <!-- endbuild -->

    <script type="text/javascript">
      angular.module('vehicleModelSearchApp', ['ngRoute'])
        .config(['$routeProvider', '$locationProvider',
          function ($routeProvider, $locationProvider) {
            $routeProvider
              .when('/', {
                templateUrl: 'views/main.html'
              })
              .when('/model/:model', {
                controller: 'trimCtrl',
                templateUrl: 'views/trim.html'
              })
              .when('/model/:model/trim/:trim', {
                controller: 'colorCtrl',
                templateUrl: 'views/color.html'
              })
              .when('/model/:model/trim/:trim/color/:ext_color_code', {
                controller: 'quoteCtrl',
                templateUrl: 'views/quote.html'
              })
              .otherwise({
                redirectTo: '/'
              });
            $locationProvider.html5Mode(false);
          }
        ])
        .constant('_', _)
        .controller('trimCtrl', function ($scope, $log, $routeParams) {
          $scope.subase = {
            ele: _.findIndex($scope.baseF.modelTrim, $routeParams),
            current: $routeParams
          };
          $log.info($routeParams, $scope.baseF.modelTrim, $scope.subase.ele);
        })
        .controller('colorCtrl', function ($scope, $log, $routeParams) {
          $scope.subase = {
            // sel: _.find($scope.baseF.modelTrimColor, { trim: $routeParams.trim }).colors[0],
            ele: _.findIndex($scope.baseF.modelTrimColor, $routeParams),
            current: $routeParams
          };
          $log.info($routeParams, _.find($scope.baseF.modelTrimColor, { trim: $routeParams.trim }), $scope.subase.sel);
        })
        .controller('quoteCtrl', function ($scope, $log, $routeParams) {
          $scope.subase = {
            sel: _.find($scope.base.collection, $routeParams)
          };
          $log.info($routeParams, $scope.subase.sel);
        })
        .controller('baseCtrl', function ($scope, $log, $http) {
          var callParams = {
            f: 'json',
            show: 'all',
            type: 'new',
            d: 'vehicles',
            make: '{setup_dealer_primary_make}',
            e: 'trim,evox_vif,ext_color_code,msrp',
            q: 'group=year,model,trim,exterior_color',
            k: 'year,model,trim,evox_vif,ext_color_code,exterior_color,msrp'
          };
          var cleanData = function (data) {
            return _.map(data, function (ele) {
              return _.assign(ele, {
                modelLabel: ele.model,
                trimLabel: ele.trim,
                model: ele.model.replace(' ', '_'),
                trim: ele.trim.replace(' ', '_').replace('/', '*')
              });
            });
          };
          var createTree = function (data) {
            var tree = {};
            // $log.info(data);
            // tree.ttsrc = '{src}';
            tree.collection = _.sortBy(data, 'ext_color_code').reverse();
            tree.yearArray = _.uniq(tree.collection, 'year');
            tree.yearSelected = tree.yearArray[0];
            // $log.info(tree.collection);
            return tree;
          };
          var filterCollection = function () {
            var data = _.where($scope.base.collection, { year: $scope.base.yearSelected.year });
            var msrpdata = _.sortBy(data, 'msrp');
            var tree = {};
            tree.models = (function () {
              var msrpuniq = _.uniq(msrpdata, 'model');
              var modeluniq = _.map(_.uniq(data, 'model'), function (ele) {
                ele.msrpfloor = _.find(msrpuniq, { model: ele.model }).msrp;
                return ele;
              });
              return _.sortBy(modeluniq, 'model');
            }());
            tree.modelTrim = _.map(tree.models, function (ele) {
              var trims = _.where(data, {
                model: ele.model
              });
              var trimsort = _.sortBy(trims, 'msrp');
              return {
                model: ele.model,
                // trimuniq: _.sortBy(_.uniq(trims, 'trim'), 'msrp')
                trimuniq: _.sortBy(
                  _.map(
                    _.uniq(trims, 'trim'), function (ele) {
                      ele.msrpfloor = _.find(trimsort, { trim: ele.trim }).msrp;
                      return ele;
                    }
                  ), 'msrp')
              }
            });
            tree.modelTrimColor = _.flatten(_.map(tree.modelTrim, function (ele) {
              var trimarray = _.map(ele.trimuniq, function (oto) {
                var colors = _.where(data, {
                  model: oto.model,
                  trim: oto.trim
                });
                // $log.info('coloresponse',colors);
                return {
                  model: oto.model,
                  trim: oto.trim,
                  colors: _.sortBy(_.uniq(colors, 'ext_color_code'), 'msrp')
                };
              });
              // $log.info('trimarray',trimarray);
              return trimarray;
            }));
            return tree;
          };
          $scope.base = {};
          $scope.$watch('base.yearSelected', function (newv, oldv) {
            if (newv) {
              $scope.baseF = filterCollection();
              // $log.info($scope.base, $scope.baseF);
            }
          });
          $http({
            // method: 'POST',
            method: 'GET',
            // url: '{home}/api/',
            url: 'model.json',
            params: callParams
          })
          .success(function (data) {
            $scope.base = createTree(cleanData(data));
          });
        });
    </script>

    <!-- build:js({.tmp,app}) scripts/scripts.js -->
    <!-- endbuild -->

    <script src="//cdn.wpdlr.co/assets/general/js/foundation/foundation.min.js" defer="" async=""></script>
    <script style="text/javascript">
      window.onload = function() { jQuery(document).foundation(); };
    </script>
  </body>
</html>
